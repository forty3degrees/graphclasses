package teo.isgci.gui;

import java.awt.Color;
import java.awt.event.InputEvent;
import java.awt.event.KeyEvent;
import java.util.HashMap;
import java.util.Map;

import javax.swing.Action;
import javax.swing.ActionMap;
import javax.swing.InputMap;
import javax.swing.JMenu;
import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;
import javax.swing.KeyStroke;

import teo.isgci.gui.ISGCIMainFrame.CreateNewFolderNodeAction;
import teo.isgci.gui.ISGCIMainFrame.CreateNewGroupNodeAction;

import y.base.Node;
import y.view.GenericNodeRealizer;
import y.view.Graph2D;
import y.view.Graph2DView;
import y.view.Graph2DViewActions;
import y.view.LineType;
import y.view.NodeLabel;
import y.view.PopupMode;
import y.view.hierarchy.DefaultGenericAutoBoundsFeature;
import y.view.hierarchy.DefaultHierarchyGraphFactory;
import y.view.hierarchy.GenericGroupNodeRealizer;
import y.view.hierarchy.HierarchyManager;

class HierarchicPopupMode extends PopupMode {
	
	protected static final Map actionNames;
	  static {
	    actionNames = new HashMap();
	    actionNames.put(Graph2DViewActions.CLOSE_GROUPS, "Close Selected Groups");
	    actionNames.put(Graph2DViewActions.OPEN_FOLDERS, "Open Selected Folders");
	    actionNames.put(Graph2DViewActions.GROUP_SELECTION, "Group Selection");
	    actionNames.put(Graph2DViewActions.UNGROUP_SELECTION, "Ungroup Selection");
	    actionNames.put(Graph2DViewActions.FOLD_SELECTION, "Fold Selection");
	    
	    

	    actionNames.put("CREATE_NEW_GROUP_NODE_ACTION", "Create Empty Group");
	    actionNames.put("CREATE_NEW_FOLDER_NODE_ACTION", "Create Empty Folder");
	    
	  }
	public static final String CONFIGURATION_GROUP = "Grouping";
	JMenuItem  infoItem;
	
	public HierarchicPopupMode(JMenuItem mI) {
		infoItem = mI;
	}
	
	 protected void populateGroupingMenu(JMenu hierarchyMenu) {
	        // Predefined actions for open/close groups
	        registerAction(hierarchyMenu, Graph2DViewActions.CLOSE_GROUPS, true);
	        registerAction(hierarchyMenu, Graph2DViewActions.OPEN_FOLDERS, true);

	        hierarchyMenu.addSeparator();

	        // Predefined actions for group/fold/ungroup
	        registerAction(hierarchyMenu, Graph2DViewActions.GROUP_SELECTION, true);
	        registerAction(hierarchyMenu, Graph2DViewActions.UNGROUP_SELECTION, true);
	        registerAction(hierarchyMenu, Graph2DViewActions.FOLD_SELECTION, true);
	      }
	
    public JPopupMenu getPaperPopup(double x, double y) {
      JPopupMenu pm = new JPopupMenu();
      populateGroupingPopup(pm, x, y, null, false);
      return pm;
    }

    public JPopupMenu getNodePopup(Node v) {
      Graph2D graph = getGraph2D();
      JPopupMenu pm = new JPopupMenu();
      populateGroupingPopup(pm, graph.getCenterX(v), graph.getCenterY(v), v, true);
      return pm;
    }

    public JPopupMenu getSelectionPopup(double x, double y) {
      JPopupMenu pm = new JPopupMenu();
      populateGroupingPopup(pm, x, y, null, getGraph2D().selectedNodes().ok());
      return pm;
    }
    
    protected HierarchyManager createHierarchyManager(Graph2D rootGraph) {
        return new HierarchyManager(rootGraph);
      }
    
    protected HierarchyManager getHierarchyManager() {
        return view.getGraph2D().getHierarchyManager();
      }
    
    protected void registerAction(final Object menu, final Object key, final boolean enabled) {
        final ActionMap viewActions = view.getCanvasComponent().getActionMap();

        final Action action = viewActions.get(key);
        if (action != null) {
          final JMenuItem item = new JMenuItem(action);
          final String name = (String) actionNames.get(key);
          if (name != null) {
            item.setText(name);
          }
          item.setEnabled(enabled);

          final InputMap imap = view.getCanvasComponent().getInputMap();
          final KeyStroke[] keyStrokes = imap.allKeys();
          if (keyStrokes != null) {
            for (int i = 0; i < keyStrokes.length; ++i) {
              if (imap.get(keyStrokes[i]) == key) {
                item.setAccelerator(keyStrokes[i]);
                break;
              }
            }
          }

          if (menu instanceof JMenu) {
            ((JMenu) menu).add(item);
          } else if (menu instanceof JPopupMenu) {
            ((JPopupMenu) menu).add(item);
          }
        }
      }
    
    protected void configureDefaultGroupNodeRealizers() {
        //Create additional configuration for default group node realizers
        DefaultHierarchyGraphFactory hgf = (DefaultHierarchyGraphFactory) getHierarchyManager().getGraphFactory();

        Map map = GenericGroupNodeRealizer.createDefaultConfigurationMap();
        GenericNodeRealizer.Factory factory = GenericNodeRealizer.getFactory();

        factory.addConfiguration(CONFIGURATION_GROUP, map);
        Object abf = factory.getImplementation(CONFIGURATION_GROUP,
            GenericGroupNodeRealizer.GenericAutoBoundsFeature.class);
        if (abf instanceof DefaultGenericAutoBoundsFeature) {
          ((DefaultGenericAutoBoundsFeature) abf).setConsiderNodeLabelSize(true);
        }

        GenericGroupNodeRealizer gnr = new GenericGroupNodeRealizer();

        //Register first, since this will also configure the node label
        gnr.setConfiguration(CONFIGURATION_GROUP);

        //Nicer colors
        gnr.setFillColor(new Color(202,236,255,132));
        gnr.setLineColor(new Color(102, 102,153,255));
        gnr.setLineType(LineType.DOTTED_1);
        NodeLabel label = gnr.getLabel();
        label.setBackgroundColor(new Color(153,204,255,255));
        label.setTextColor(Color.BLACK);
        label.setFontSize(15);

        hgf.setProxyNodeRealizerEnabled(true);

        hgf.setDefaultGroupNodeRealizer(gnr.createCopy());

        //Set the correct initial group state for folder nodes
        gnr.setGroupClosed(true);
        hgf.setDefaultFolderNodeRealizer(gnr.createCopy());
      }
    
    protected void populateGroupingPopup(JPopupMenu pm, final double x, final double y, Node node, boolean selected) {
        // Predefined actions for open/close groups
        registerAction(
            pm, Graph2DViewActions.CLOSE_GROUPS,
            node != null && getHierarchyManager().isGroupNode(node));
        	
        registerAction(
            pm, Graph2DViewActions.OPEN_FOLDERS,
            node != null && getHierarchyManager().isFolderNode(node));
        	
        pm.addSeparator();

        // Predefined actions for group/fold/ungroup
        registerAction(pm, Graph2DViewActions.GROUP_SELECTION, selected);
        registerAction(pm, Graph2DViewActions.UNGROUP_SELECTION, selected);
        registerAction(pm, Graph2DViewActions.FOLD_SELECTION, selected);

        pm.addSeparator();

        //We customize both "Create..." actions so that the newly created node lies at the coordinates of the mouse click
        //(for "Group Selection"/"Fold Selection", the location is determined by the content's location instead.
        JMenuItem item = new JMenuItem(new CreateNewGroupNodeAction(view){
          protected void setGroupNodeBounds(Graph2DView view, Graph2D graph, Node groupNode) {
            graph.setLocation(groupNode, x, y);
          }
        });
        item.setText("Create Empty Group");
        item.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_G, InputEvent.CTRL_MASK | InputEvent.SHIFT_MASK));
        pm.add(item);

        item = new JMenuItem(new CreateNewFolderNodeAction(view){
          protected void setFolderNodeBounds(Graph2DView view, Graph2D graph, Node groupNode) {
            graph.setLocation(groupNode, x, y);
          }
        });
        item.setText("Create Empty Folder");
        item.setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_F, InputEvent.CTRL_MASK | InputEvent.SHIFT_MASK));
        pm.add(item);
        add(infoItem = new JMenuItem("Information"));
        infoItem.addActionListener(this);       
        
        
        pm.add(infoItem);
      }
  }
